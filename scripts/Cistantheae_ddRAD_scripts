#!/bin/bash

############# Cistantheae ddRAD PHYLOGENY project: ipyrad pipeline and downstream analyses (IQtree, TETRAD, vcftools) #############

# Anri Chomentowska, updated 2025


###### 1. Make an environment for ipyrad ######
ssh #log into yale mccleary server
srun --pty -t 30:00 -p devel bash

module load miniconda #available on yale mccleary
conda create -n ipyrad_0_9_81 Python=3.7

conda activate ipyrad_0_9_81
conda install ipyrad=0.9.81 -c conda-forge -c bioconda

#UPDATE due to error
conda install -c bioconda vsearch=2.19


###### 2. Make a new params file on mcleary (in a specfific directory) per ddRAD plate ######
module load miniconda
conda activate ipyrad_new_0_9_81

ipyrad -n ddrad_plate8 #this makes a params file

### Edit the params file (e.g. params-ddrad_plate8.txt)
# MAKE SURE ALL THE PATHS ARE CORRECT!
# Do this again for the whole-genome reference (here just coding sequences)
```
------- ipyrad params file (v.0.9.81)-------------------------------------------
ddrad_plate8                   ## [0] [assembly_name]: Assembly name. Used to name output directories for assembly steps
/vast/palmer/scratch/edwards/ac2767/ddradseqs ## [1] [project_dir]: Project dir (made in curdir if not present)
/gpfs/gibbs/project/edwards/ac2767/ddrad_raw_reads/GC3F-AC-9079---8067_S1_L001_R1_001.fastq.gz ## [2] [raw_fastq_path]: Location of raw non-demultiplexed fastq files
/gpfs/gibbs/project/edwards/ac2767/ddrad_barcode_files/AC8barcode.txt ## [3] [barcodes_path]: Location of barcodes file
                               ## [4] [sorted_fastq_path]: Location of demultiplexed/sorted fastq files
reference                      ## [5] [assembly_method]: Assembly method (denovo, reference)
/gpfs/gibbs/project/edwards/ac2767/genome_assembled/cislon_cds.fasta ## [6] [reference_sequence]: Location of reference sequence file
ddrad                          ## [7] [datatype]: Datatype (see docs): rad, gbs, ddrad, etc.
TGCAG, CCG                     ## [8] [restriction_overhang]: Restriction overhang (cut1,) or (cut1, cut2)
5                              ## [9] [max_low_qual_bases]: Max low quality base calls (Q<20) in a read
33                             ## [10] [phred_Qscore_offset]: phred Q score offset (33 is default and very standard)
6                              ## [11] [mindepth_statistical]: Min depth for statistical base calling
6                              ## [12] [mindepth_majrule]: Min depth for majority-rule base calling
10000                          ## [13] [maxdepth]: Max cluster depth within samples
0.98                           ## [14] [clust_threshold]: Clustering threshold for de novo assembly
0                              ## [15] [max_barcode_mismatch]: Max number of allowable mismatches in barcodes
2                              ## [16] [filter_adapters]: Filter for adapters/primers (1 or 2=stricter)
35                             ## [17] [filter_min_trim_len]: Min length of reads after adapter trim
4                              ## [18] [max_alleles_consens]: Max alleles per site in consensus sequences
0.05                           ## [19] [max_Ns_consens]: Max N's (uncalled bases) in consensus
0.05                           ## [20] [max_Hs_consens]: Max Hs (heterozygotes) in consensus
4                              ## [21] [min_samples_locus]: Min # samples per locus for output
0.1                            ## [22] [max_SNPs_locus]: Max # SNPs per locus
5                              ## [23] [max_Indels_locus]: Max # of indels per locus
0.25                           ## [24] [max_shared_Hs_locus]: Max # heterozygous sites per locus
0, 0, 0, 0                     ## [25] [trim_reads]: Trim raw read edges (R1>, <R1, R2>, <R2) (see docs)
0, 0, 0, 0                     ## [26] [trim_loci]: Trim locus edges (see docs) (R1>, <R1, R2>, <R2)
l, p, s, n, k, a, g, G, u, v, t, m ## [27] [output_formats]: Output formats (see docs)
                               ## [28] [pop_assign_file]: Path to population assignment file
                               ## [29] [reference_as_filter]: Reads mapped to this reference are removed in step 3

```

### Run steps 1 and 2 on the new reads; save following to batch script slurm_ipyrad_steps12.sh
# and submit this
sbatch slurm_ipyrad_steps12.sh

```
#!/bin/bash
#SBATCH --partition pi_edwards,day
#SBATCH --cpus-per-task 20
#SBATCH --time 8:00:00
#SBATCH --mem-per-cpu 8G
#SBATCH --job-name ddrad_ipyrad
#SBATCH --output ddrad_ipyrad_output-%j.txt
#SBATCH --error ddrad_ipyrad_error-%j.txt
#SBATCH --mail-type ALL
#SBATCH --chdir /home/ac2767/project/ddradseqs

## Change the environment
module load miniconda
conda activate ipyrad_new_0_9_81

## Makes me upset but it works
ipcluster start --n 20 --daemonize
sleep 90

## Run steps for all assemblies
ipyrad -p params-ddrad_plate8.txt -s 12 -d --ipcluster

## Stop ipcluster i guess
ipcluster stop

```


###### 3. Use output from all plates to run rest of ipyrad pipeline ######

### Combine step 2 output fastq.gz files from all plates to its own directory (e.g., .../demultiplexed_reads/)
# Make a new ipyrad params file
# RUN steps ipyrad 1 and 2
ipyrad -n ddrad_demultiplexed_phylo_reads

ipyrad -p params-ddrad_demultiplexed_phylo_reads.txt -s 12 -d #or, use slurm_ipyrad_steps12.sh

# PARAMS FILE of params-ddrad_demultiplexed_phylo_reads.txt
```
------- ipyrad params file (v.0.9.81)-------------------------------------------
ddrad_demultiplexed_phylo_reads ## [0] [assembly_name]: Assembly name. Used to name output directories for assembly steps
/gpfs/gibbs/project/edwards/ac2767/ddradseqs ## [1] [project_dir]: Project dir (made in curdir if not present)
                               ## [2] [raw_fastq_path]: Location of raw non-demultiplexed fastq files
                               ## [3] [barcodes_path]: Location of barcodes file
/gpfs/gibbs/project/edwards/ac2767/demultiplexed_reads/*.fastq.gz ## [4] [sorted_fastq_path]: Location of demultiplexed/sorted fastq files
reference                      ## [5] [assembly_method]: Assembly method (denovo, reference)
/gpfs/gibbs/project/edwards/ac2767/genome_assembled/cislon_cds.fasta ## [6] [reference_sequence]: Location of reference sequence file
ddrad                          ## [7] [datatype]: Datatype (see docs): rad, gbs, ddrad, etc.
TGCAG, CCG                     ## [8] [restriction_overhang]: Restriction overhang (cut1,) or (cut1, cut2)
5                              ## [9] [max_low_qual_bases]: Max low quality base calls (Q<20) in a read
33                             ## [10] [phred_Qscore_offset]: phred Q score offset (33 is default and very standard)
6                              ## [11] [mindepth_statistical]: Min depth for statistical base calling
6                              ## [12] [mindepth_majrule]: Min depth for majority-rule base calling
10000                          ## [13] [maxdepth]: Max cluster depth within samples
0.98                           ## [14] [clust_threshold]: Clustering threshold for de novo assembly
0                              ## [15] [max_barcode_mismatch]: Max number of allowable mismatches in barcodes
2                              ## [16] [filter_adapters]: Filter for adapters/primers (1 or 2=stricter)
35                             ## [17] [filter_min_trim_len]: Min length of reads after adapter trim
4                              ## [18] [max_alleles_consens]: Max alleles per site in consensus sequences
0.05                           ## [19] [max_Ns_consens]: Max N's (uncalled bases) in consensus
0.05                           ## [20] [max_Hs_consens]: Max Hs (heterozygotes) in consensus
4                              ## [21] [min_samples_locus]: Min # samples per locus for output
0.1                            ## [22] [max_SNPs_locus]: Max # SNPs per locus
5                              ## [23] [max_Indels_locus]: Max # of indels per locus
0.25                           ## [24] [max_shared_Hs_locus]: Max # heterozygous sites per locus
0, 0, 0, 0                     ## [25] [trim_reads]: Trim raw read edges (R1>, <R1, R2>, <R2) (see docs)
0, 0, 0, 0                     ## [26] [trim_loci]: Trim locus edges (see docs) (R1>, <R1, R2>, <R2)
l, p, s, n, k, a, g, G, u, v, t, m ## [27] [output_formats]: Output formats (see docs)
                               ## [28] [pop_assign_file]: Path to population assignment file
                               ## [29] [reference_as_filter]: Reads mapped to this reference are removed in step 3


```

### Trim samples that are less than 100,000 reads past filter after step 2 using branching flag '-b' and exclusion flag '-'
# and trim samples with no reads that passes consensus base/allele calling in step 5 (Montia_fontana_AC100)
ipyrad -p params-ddrad_demultiplexed_phylo_reads.txt -b ddrad_phylo_reads_passed - Calandrinia_caespitosa_AC391 Cistanthe_aff_cymosa_AC63 Cistanthe_aff_cymosa_AC68 Cistanthe_celosiodes_AC361 Cistanthe_picta_AC419 Cistanthe_picta_AC421 Cistanthe_sp_AC06 Claytonia_sibrica_AC99 Montiopsis_berteroana_AC414 Montiopsis_cistiflora_AC403 Montiopsis_conferta_AC411 Montiopsis_gillesii_AC393 Phemeranthus_brevicaulis_LPH27 Phemeranthus_parvulus_AC229 Montia_fontana_AC100

### Run steps 3 through 7 using slurm_ipyrad_steps37.sh
```bash
#!/bin/bash
#SBATCH --partition pi_edwards,day
#SBATCH --cpus-per-task 20
#SBATCH --time 24:00:00
#SBATCH --mem-per-cpu 8G
#SBATCH --job-name ddrad_ipyrad
#SBATCH --output ddrad_ipyrad_steps37_output-%j.txt
#SBATCH --error ddrad_ipyrad_steps37_error-%j.txt
#SBATCH --mail-type ALL
#SBATCH --chdir /home/ac2767/project/ddradseqs

## change the environment
module load miniconda
conda activate ipyrad_new_0_9_81

## Makes me upset
ipcluster start --n 20 --daemonize
sleep 90

## run steps for all assemblies
ipyrad -p params-ddrad_phylo_reads_passed.txt -s 34567 -d --ipcluster

## Stop ipcluster i guess
ipcluster stop
```

# If more samples trimmed or after making subclade-level matrices (just list samples wtihout using '-' flag when branching), re-run just steps 6 and 7
ipyrad -p params-ddrad_phylo_reads_passed.txt -b ddrad_phylo_reads_v14 Calandrinia_affinis_AC134 Calandrinia_affinis_SGD313 Calandrinia_caespitosa_AC397 Calandrinia_caespitosa_AC398 Calandrinia_colchagnensis_AC126 Calandrinia_compacta_AC390 Calandrinia_compacta_AC396 Calyptridium_arizonicum_AC365 Calyptridium_monandrum_AC384 Calyptridium_monandrum_SGD50 Calyptridium_monospermum_AC148 Calyptridium_monospermum_AC185 Calyptridium_nevadense_AC445 Calyptridium_parryi_v_hesseae_AC150 Calyptridium_parryi_v_hesseae_AC151 Calyptridium_parryi_v_parryi_AC206 Calyptridium_pygmaeum_AC145 Calyptridium_pygmaeum_AC146 Calyptridium_roseum_AC227 Calyptridium_umbellatum_AC152 Calyptridium_umbellatum_SGD113 Cistanthe_aff_calycina_AC08 Cistanthe_aff_calycina_AC46 Cistanthe_aff_cymosa_AC33 Cistanthe_aff_cymosa_AC362 Cistanthe_aff_cymosa_AC74 Cistanthe_aff_grandiflora_AC130 Cistanthe_aff_longiscapa_AC77 Cistanthe_amaranthoides_AC36 Cistanthe_amaranthoides_AC76 Cistanthe_ambigua_AC435 Cistanthe_ambigua_AC436 Cistanthe_ambigua_AC438 Cistanthe_cachinalensis_AC15 Cistanthe_cachinalensis_AC425 Cistanthe_cachinalensis_AC78 Cistanthe_calycina_AC117 Cistanthe_celosiodes_AC356 Cistanthe_celosioides_AC114 Cistanthe_celosioides_AC82 Cistanthe_cephalophora_AC59 Cistanthe_cf_thyrsoidea_AC115 Cistanthe_coquimbensis_AC04 Cistanthe_cymosa_AC28 Cistanthe_densiflora_AC120 Cistanthe_densiflora_AC423 Cistanthe_discolor_AC129 Cistanthe_grandiflora_AC03 Cistanthe_grandiflora_AC96 Cistanthe_laxiflora_MA102 Cistanthe_aff_longiscapa_AC84 Cistanthe_longiscapa_AC80 Cistanthe_aff_littoralis_AC72 Cistanthe_sp2_thyrsoidea_AC108 Cistanthe_sp_AC11 Cistanthe_longiscapa_AC64 Cistanthe_longiscapa_AC53 Cistanthe_longiscapa_AC75 Cistanthe_maritima_AC142 Cistanthe_maritima_AC450 Cistanthe_mucronulata_AC127 Cistanthe_mucronulata_AC88 Cistanthe_pachyphylla_AC86 Cistanthe_paniculata_AC358 Cistanthe_paniculata_AC360 Cistanthe_paniculata_AC385 Cistanthe_picta_AC137 Cistanthe_picta_AC90 Cistanthe_picta_AC426 Cistanthe_picta_SGD302 Cistanthe_picta_SGD322 Cistanthe_salsoloides_AC412 Cistanthe_salsoloides_AC433 Cistanthe_grandiflora_AC14 Cistanthe_grandiflora_AC48 Cistanthe_sp_pompom_AC40 Lenzia_chamaepitys_AC428 Lewisiopsis_tweedyi_JdV4 Montiopsis_andicola_AC124 Montiopsis_berteroana_AC406 Montiopsis_berteroana_SGD337 Montiopsis_capitata_SGD330 Montiopsis_cistiflora_SGD338 Montiopsis_compiapina_SGD332 Montiopsis_conferta_AC405 Montiopsis_conferta_SGD339 Montiopsis_cumingii_AC133 Montiopsis_cumingii_SGD303 Montiopsis_gayana_AC123 Montiopsis_gayana_AC125 Montiopsis_gayana_AC402 Montiopsis_gillesii_AC392 Montiopsis_gillesii_AC420 Montiopsis_gilliesii_AC92 Montiopsis_potentilloides_AC418 Montiopsis_ramosissima_AC128 Montiopsis_ramosissima_AC131 Montiopsis_sericea_AC136 Montiopsis_sericea_SGD325 Montiopsis_trifida_AC122 Montiopsis_umbellatum_AC408 Calyptridium_pulchellum_AC246 Calyptridium_pulchellum_AC279 Cistanthe_frigida_SGD333 Montiopsis_andicola_SGD309 Cistanthe_arenaria_AC121 Phemeranthus_punae_MA70 Phemeranthus_confertiflorus_MA78

ipyrad -p params-ddrad_phylo_reads_v14.txt -s 67 -d --ipcluster #using slurm_ipyrad_steps67.sh


###### 4. Use .phy output from ipyrad to run IQtree ######

### Install iqtree into new environment
module load miniconda
conda create -n iqtree

conda activate iqtree
conda install -c bioconda iqtree

### Write a batch script to run iqtree
```
#!/bin/bash
#SBATCH --partition pi_edwards,week
#SBATCH --cpus-per-task 20
#SBATCH --time 96:00:00
#SBATCH --mem-per-cpu 8G
#SBATCH --job-name iqtree_ALL
#SBATCH --output iqtree_ALL_output-%j.txt
#SBATCH --error iqtree_ALL_error-%j.txt
#SBATCH --mail-type ALL
#SBATCH --chdir /home/ac2767/palmer_scratch/ddradseqs/ddrad_phylo_reads_v14_outfiles

## Change the environment
module load miniconda
conda activate iqtree

## Run iqtree w ultrafast bootstraps w 1000 replicates by putting flag B 1000
iqtree -s ddrad_phylo_reads_v14.phy -m GTR+I+G -t RANDOM -T AUTO -pers 0.2 -nstop 500 -B 1000 -seed 111 -pre iqtree_111
```

# If using model testing (via ModelFinder)
iqtree -s ddrad_phylo_reads_v14.phy -T AUTO -pers 0.2 -nstop 500 -B 1000 -seed 111 -pre iqtree_MF_111


###### 5. Use .snps.hdf5 output from ipyrad to run IQtree ######

### Make a new environment
module load miniconda
conda create -n tetrad_py37 Python=3.7

conda activate tetrad_py37
# In this environment install:
conda install ipyrad=0.9.81 -c conda-forge -c bioconda
conda install tetrad -c eaton-lab -c conda-forge

### Run tetrad by saving below to slurm_tetrad.sh
```
#!/bin/bash
#SBATCH --partition pi_edwards,day
#SBATCH --cpus-per-task 20
#SBATCH --time 12:00:00
#SBATCH --mem-per-cpu 16G
#SBATCH --job-name ddrad_tetrad
#SBATCH --output ddrad_tetrad_output-%j.txt
#SBATCH --error ddrad_tetrad_error-%j.txt
#SBATCH --mail-type ALL
#SBATCH --chdir /home/ac2767/project/ddradseqs/ddrad_phylo_reads_v14_outfiles

## Change the environment
module load miniconda
conda activate tetrad_py37

## Makes me upset still
ipcluster start --n 20 --daemonize
sleep 90

## Run tetrad
tetrad -i ddrad_phylo_reads_v14.snps.hdf5 -n v14_tetrad -o tetrad_output -q 1e6 -b 1000 -c 20 --ipcluster

## Stop ipcluster i guess
ipcluster stop
```


###### 6. Use the .vcf output from ipyrad to trim matrix per subclade to prepare for sNMF in R ######

### Calculate the longest loci for each vcf file
srun --pty -t 10:00 -p devel bash

module load Python/3.10.8-GCCcore-12.2.0 #available on yale mccleary
python calculate_length.py

### Filter VCFs
# use --thin 700 == length of longest loci
# do this for both coding-sequence referenced and whole-genome referenced matrices
srun --pty -t 10:00 -p devel bash
module load VCFtools/0.1.16-GCCcore-10.2.0

# Calyptridium
# try some different levels of missingness, check resulting number of SNPs
vcftools --vcf ddrad_ingroup_calyptridium_min11_genomeref.vcf --maf 0.05 --min-alleles 2 --max-alleles 2 --max-missing 0.7 --thin 700 --recode --recode-INFO-all --out calyptridium_genomeref_min11
vcftools --vcf ddrad_ingroup_calyptridium_min11_genomeref.vcf --maf 0.05 --min-alleles 2 --max-alleles 2 --max-missing 0.8 --thin 700 --recode --recode-INFO-all --out calyptridium_genomeref_min11_0.8
vcftools --vcf ddrad_ingroup_calyptridium_min11_genomeref.vcf --maf 0.05 --min-alleles 2 --max-alleles 2 --max-missing 0.85 --thin 700 --recode --recode-INFO-all --out calyptridium_genomeref_min11_0.85

# Montiopsis
vcftools --vcf ddrad_ingroup_montiopsis_min10_genomeref.vcf --maf 0.05 --min-alleles 2 --max-alleles 2 --max-missing 0.85 --thin 700 --recode --recode-INFO-all --out mont_genomeref_min10_0.85

# Philippiamra


# Cistanthe sect. rosulate
# straglers ended up in these matrices, trim with --remove
vcftools --vcf ddrad_ingroup_sect_cistanthe_trim_min8_cdsref.vcf --remove remove_samples.txt --recode --recode-INFO-all --out filtered_sect_cistanthe_trim_min8_cdsref
vcftools --vcf filtered_sect_cistanthe_trim_min8_cdsref.recode.vcf --maf 0.05 --min-alleles 2 --max-alleles 2 --max-missing 0.85 --thin 700 --recode --recode-INFO-all --out scist_trim_cdsref_min8_filtered_0.85
vcftools --vcf filtered_sect_cistanthe_trim_min8_cdsref.recode.vcf --maf 0.05 --min-alleles 2 --max-alleles 2 --max-missing 0.9 --thin 700 --recode --recode-INFO-all --out scist_trim_cdsref_min8_filtered_0.9

vcftools --vcf ddrad_ingroup_sect_cistanthe_trim_min8_genomeref.vcf --remove remove_samples.txt --recode --recode-INFO-all --out filtered_sect_cistanthe_trim_min8_genomeref
vcftools --vcf filtered_sect_cistanthe_trim_min8_genomeref.recode.vcf --maf 0.05 --min-alleles 2 --max-alleles 2 --max-missing 0.9 --thin 700 --recode --recode-INFO-all --out scist_trim_genomeref_min8_filtered_0.9

# Cistanthe sect. rosulate
vcftools --vcf ddrad_ingroup_sect_rosulate_min11_cdsref.vcf --remove remove_samples.txt --recode --recode-INFO-all --out filtered_sect_rosulate_min11_cdsref
vcftools --vcf filtered_sect_rosulate_min11_cdsref.recode.vcf --maf 0.05 --min-alleles 2 --max-alleles 2 --max-missing 0.8 --thin 700 --recode --recode-INFO-all --out srosu_cdsref_min8_filtered_0.8

vcftools --vcf ddrad_ingroup_sect_rosulate_min11_genomeref.vcf --remove remove_samples.txt --recode --recode-INFO-all --out filtered_sect_rosulate_min11_genomeref
vcftools --vcf filtered_sect_rosulate_min11_genomeref.recode.vcf --maf 0.05 --min-alleles 2 --max-alleles 2 --max-missing 0.85 --thin 700 --recode --recode-INFO-all --out srosu_genomeref_min8_filtered_0.85
